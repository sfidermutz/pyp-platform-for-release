name: Smoke (manual)

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Smoke test - create session
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          set -e
          SESSION_JSON=$(curl -s -X POST "$DEPLOY_URL/api/create-session" -H "Content-Type: application/json" -d '{"token":"demo-token-123"}')
          echo "$SESSION_JSON" > session.json
          echo "SESSION_JSON:"
          cat session.json

      - name: Store scenario metrics
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          SESSION_ID=$(jq -r '.session.id // .id // empty' session.json)
          if [ -z "$SESSION_ID" ]; then echo "session id not found"; exit 1; fi
          curl -s -X POST "$DEPLOY_URL/api/store-scenario-metrics" -H "Content-Type: application/json" -d "{\"session_id\":\"$SESSION_ID\", \"scenario_id\":\"HYB-PRE-01\", \"metrics\":{\"mission_score\":50}, \"meta\":{\"smoke\":true}}" -o store.json
          echo "store response:"
          cat store.json

      - name: Compute debrief
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          SESSION_ID=$(jq -r '.session.id // .id // empty' session.json)
          curl -s -X POST "$DEPLOY_URL/api/compute-debrief" -H "Content-Type: application/json" -d "{\"session_id\":\"$SESSION_ID\",\"scenario_id\":\"HYB-PRE-01\",\"selections\":{\"1\":{\"optionId\":\"1C\",\"confidence\":70},\"2\":{\"optionId\":\"2B2\",\"confidence\":70},\"3\":{\"optionId\":\"3A1\",\"confidence\":60}},\"reflection\":\"Smoke test reflection\"}" -o compute.json
          echo "compute response:"
          cat compute.json

      - name: Fetch debrief
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          SESSION_ID=$(jq -r '.session.id // .id // empty' session.json)
          curl -s "$DEPLOY_URL/api/debrief?session_id=$SESSION_ID&scenario_id=HYB-PRE-01" -o debrief.json
          echo "Debrief:"
          cat debrief.json
